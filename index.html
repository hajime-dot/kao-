<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>é«˜é›„æ—…äººæ‰‹æœ­</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#F7F7F5">
<link rel="apple-touch-icon" href="https://img.icons8.com/color/180/taiwan-map.png">

<style>
    :root {
        --bg-color: #F7F7F5;
        --card-bg: #FFFFFF;
        --text-main: #3E3E3E;
        --text-sub: #888888;
        --accent-green: #7D9D9C;
        --accent-red: #D9534F;
        --accent-orange: #E09B6B;
        --accent-purple: #9E8FB2;
        --accent-blue: #5B84B1;
        --nav-height: 80px;
        --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: var(--bg-color);
        margin: 0; padding: 0;
        display: flex; justify-content: center;
        height: 100dvh; color: var(--text-main);
        overflow: hidden;
    }

    #app-container {
        width: 100%; max-width: 500px;
        background-color: var(--bg-color);
        height: 100%; position: relative;
        display: flex; flex-direction: column;
    }

    header { padding: 40px 20px 10px; background: var(--bg-color); flex-shrink: 0; }
    h1 { margin: 0; font-size: 26px; font-weight: 800; letter-spacing: 1px; }
    .subtitle { font-size: 14px; color: var(--text-sub); margin-top: 5px; font-weight: 500; }

    #main-content {
        flex: 1; overflow-y: auto;
        padding: 10px 20px 100px;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
    }
    #main-content::-webkit-scrollbar { display: none; }

    /* --- UI Components --- */
    .date-scroll {
        display: flex; gap: 12px; overflow-x: auto;
        padding: 5px 2px 15px 2px; margin-bottom: 5px;
    }
    .date-scroll::-webkit-scrollbar { display: none; }
    
    .date-chip {
        background: var(--card-bg); padding: 10px 18px; border-radius: 24px;
        font-size: 14px; white-space: nowrap; color: var(--text-sub);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: 500; cursor: pointer;
    }
    .date-chip.active { background: var(--text-main); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

    .card {
        background: var(--card-bg); border-radius: 16px; padding: 18px;
        margin-bottom: 16px; box-shadow: var(--shadow);
        position: relative; border-left: 5px solid #ddd;
    }
    
    .card.type-food { border-left-color: var(--accent-orange); }
    .card.type-spot { border-left-color: var(--accent-green); }
    .card.type-transport { border-left-color: var(--accent-blue); background-color: #F8FAFC; }
    .card.type-hotel { border-left-color: var(--accent-purple); }

    .card-time { font-size: 13px; color: var(--text-sub); font-weight: 700; margin-bottom: 6px; display: block; }
    .card-title { font-size: 18px; font-weight: 800; margin-bottom: 6px; color: #222; }
    .card-desc { font-size: 14px; color: #555; line-height: 1.5; margin-bottom: 12px; }
    
    .tag { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 5px; margin-right: 5px; font-weight: 700; }
    .tag-bus { background: #E1E8ED; color: var(--accent-blue); }
    .tag-booking { background: #FFEBEE; color: var(--accent-red); }
    .tag-walk { background: #E8F5E9; color: #2E7D32; }

    .btn-nav {
        display: inline-flex; align-items: center; background: #FFF;
        color: var(--text-main); padding: 6px 14px; border-radius: 20px;
        text-decoration: none; font-size: 12px; font-weight: 700; border: 1px solid #EEE;
    }

    /* --- Money Section Styles --- */
    .money-input-group { background: white; padding: 20px; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 20px; }
    .form-row { margin-bottom: 15px; }
    .form-label { font-size: 12px; font-weight: bold; color: #888; margin-bottom: 5px; display: block; }
    .form-input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 8px; font-size: 16px; -webkit-appearance: none;}
    .form-select { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 8px; font-size: 16px; background: white;}
    
    .member-checks { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
    .member-check-item { 
        padding: 8px 12px; border-radius: 20px; border: 1px solid #eee; 
        font-size: 13px; cursor: pointer; transition: all 0.2s; user-select: none;
    }
    .member-check-item.checked { background: var(--text-main); color: white; border-color: var(--text-main); }

    .btn-add { 
        width: 100%; background: var(--text-main); color: white; border: none; 
        padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer;
    }
    
    .balance-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; }
    .balance-amt { font-weight: 800; font-size: 16px; }
    .is-plus { color: var(--accent-green); } /* æ‡‰æ”¶ */
    .is-minus { color: var(--accent-red); } /* æ‡‰ä»˜ */

    .history-item { font-size: 13px; padding: 12px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .history-desc { font-weight: bold; }
    .history-detail { color: #999; font-size: 11px; margin-top: 2px; }
    
    /* FIX: Button Style for iPhone */
    .btn-delete { 
        background-color: transparent;
        border: 1px solid #ffcccc;
        color: var(--accent-red); 
        margin-left: 10px; 
        padding: 5px 12px; /* Bigger touch area */
        cursor: pointer; 
        border-radius: 12px;
        font-size: 14px;
        font-weight: bold;
    }
    .btn-delete:active { background-color: #ffebeb; }

    /* --- Navigation --- */
    .bottom-nav {
        position: absolute; bottom: 0; width: 100%; height: var(--nav-height);
        background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
        display: flex; justify-content: space-around; padding-top: 10px;
        border-top: 1px solid rgba(0,0,0,0.05); z-index: 100;
    }
    .nav-item { flex: 1; text-align: center; color: #bbb; font-size: 10px; cursor: pointer; }
    .nav-item.active { color: var(--text-main); }
    .nav-icon { font-size: 22px; display: block; margin-bottom: 2px;}

    .section { display: none; animation: fadeIn 0.3s ease; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Flight Info Styles */
    .info-group { margin-bottom: 24px; }
    .info-header { font-size: 13px; font-weight: 800; color: var(--text-sub); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1.5px; padding-left: 5px; }
    .info-block { background: white; border-radius: 12px; padding: 15px; box-shadow: var(--shadow); margin-bottom: 10px;}
    .flight-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px;}
    .flight-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .flight-time { font-weight: bold; color: #333; }
    .flight-code { color: #666; font-size: 12px; }
    .flight-ppl { font-size: 11px; color: var(--accent-blue); margin-top: 2px;}

</style>
</head>
<body>

<div id="app-container">
    <header>
        <h1>é«˜é›„æ…¢æ—… ğŸ‡¹ğŸ‡¼</h1>
        <div class="subtitle" id="header-subtitle">Travel Log</div>
    </header>

    <div id="main-content">
        
        <div id="sec-itinerary" class="section active">
            <div class="date-scroll" id="date-tabs"></div>
            <div id="cards-container"></div>
        </div>

        <div id="sec-money" class="section">
            <div class="money-input-group">
                <h3 style="margin-top:0; margin-bottom:15px;">æ–°å¢æ”¯å‡º (Add Expense)</h3>
                
                <div class="form-row">
                    <label class="form-label">é …ç›® (Description)</label>
                    <input type="text" id="m-desc" class="form-input" placeholder="e.g. æ™šé¤, é–€ç¥¨...">
                </div>
                
                <div class="form-row" style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label class="form-label">é‡‘é¡ (Amount)</label>
                        <input type="number" id="m-amt" class="form-input" placeholder="$">
                    </div>
                    <div style="flex:1;">
                        <label class="form-label">ä»˜æ¬¾äºº (Payer)</label>
                        <select id="m-payer" class="form-select">
                            </select>
                    </div>
                </div>

                <div class="form-row">
                    <label class="form-label">åˆ†æ”¤è€… (Split with) <small onclick="toggleAllChecks()" style="float:right; color:blue; cursor:pointer;">å…¨é¸/å…¨ä¸é¸</small></label>
                    <div id="m-targets" class="member-checks">
                        </div>
                </div>

                <button class="btn-add" onclick="addExpense()">ï¼‹ è¨˜ä¸€ç­†</button>
            </div>

            <div class="info-header">çµé¤˜ (Balance Status)</div>
            <div id="balance-list">
                </div>
            
            <div class="info-header" style="margin-top:20px;">ç´€éŒ„ (History)</div>
            <div id="history-list" style="background:white; padding:10px 20px; border-radius:12px; box-shadow:var(--shadow);">
                </div>
            <div style="text-align:center; margin-top:20px;">
                <button onclick="clearAllData()" style="background:none; border:none; color:#ccc; font-size:12px;">âš ï¸ æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
            </div>
        </div>

        <div id="sec-info" class="section">
            <div class="info-group">
                <div class="info-header">ä½å®¿</div>
                <div class="card type-hotel" style="margin-bottom:0;">
                    <span class="card-time">Check-in 15:00 / Out 11:00</span>
                    <div class="card-title">æ„›æ²³â€§æ—¥å¤® B&B</div>
                    <div class="card-desc">é«˜é›„å¸‚å‰é‡‘å€</div>
                    <a href="https://www.google.com/maps/search/?api=1&query=æ„›æ²³æ—¥å¤®" target="_blank" class="btn-nav">ğŸ“ å°èˆª</a>
                </div>
            </div>

            <div class="info-group">
                <div class="info-header">èˆªç­</div>
                <div class="info-block">
                    <div style="font-weight:bold; margin-bottom:10px; color:#333;">ğŸ‡­ğŸ‡° é¦™æ¸¯ (HKG) â†” é«˜é›„ (KHH)</div>
                    <div class="flight-row">
                        <div><div class="flight-time">ğŸ›« 19/2 10:30</div><div class="flight-code">AE984 / CI934</div></div>
                        <div style="text-align:right;"><div class="flight-ppl">å¥, æ°´, æŸ, é‚¦</div></div>
                    </div>
                    <div class="flight-row">
                        <div><div class="flight-time">ğŸ›« 20/2 10:30</div><div class="flight-code">CI934</div></div>
                        <div style="text-align:right;"><div class="flight-ppl">åˆ</div></div>
                    </div>
                    <div class="flight-row">
                        <div><div class="flight-time">ğŸ›¬ 23/2 18:00</div><div class="flight-code">CI935</div></div>
                        <div style="text-align:right;"><div class="flight-ppl">å…¨å“¡å›æ¸¯</div></div>
                    </div>
                </div>
                <div class="info-block">
                    <div style="font-weight:bold; margin-bottom:10px; color:#333;">ğŸ‡»ğŸ‡³ èƒ¡å¿—æ˜ â†” é«˜é›„</div>
                    <div class="flight-row">
                        <div><div class="flight-time">ğŸ›« 19/2 07:35</div><div class="flight-code">VJ886</div></div>
                        <div style="text-align:right;"><div class="flight-ppl">å®œ (Boyi)</div></div>
                    </div>
                    <div class="flight-row">
                        <div><div class="flight-time">ğŸ›¬ 23/2 12:45</div><div class="flight-code">VJ885</div></div>
                        <div style="text-align:right;"><div class="flight-ppl">å®œ (Boyi)</div></div>
                    </div>
                </div>
            </div>
            
            <div class="info-group">
                <div class="info-header">æˆå“¡</div>
                <div class="info-block" style="padding:10px; font-size:14px; color:#555;">
                   ğŸ‘¯ æ°´, é‚¦, å¥, åˆ, æŸ, Boyi, çª, Sean (8äºº)
                </div>
            </div>
        </div>

    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('sec-itinerary', this)">
            <span class="nav-icon">ğŸ—“ï¸</span><span>è¡Œç¨‹</span>
        </div>
        <div class="nav-item" onclick="switchTab('sec-money', this)">
            <span class="nav-icon">ğŸ’°</span><span>å…¬æ•¸</span>
        </div>
        <div class="nav-item" onclick="switchTab('sec-info', this)">
            <span class="nav-icon">ğŸ§³</span><span>è³‡è¨Š</span>
        </div>
    </nav>
</div>

<script>
    // === 1. Data Source ===
    const members = ['æ°´', 'é‚¦', 'å¥', 'åˆ', 'æŸ', 'Boyi', 'çª', 'Sean'];
    
    const itinerary = [
        {
            date: "02/19 (å››)",
            events: [
                { time: "10:30", title: "èµ·é£› HKG->KHH", type: "transport", desc: "å¥æ°´æŸé‚¦å‡ºç™¼ (CI934)ã€‚", loc: "é¦™æ¸¯åœ‹éš›æ©Ÿå ´" },
                { time: "13:00", title: "å°æ¸¯æ©Ÿå ´é›†åˆ", type: "transport", desc: "èˆ‡ Boyi æœƒåˆã€‚", loc: "é«˜é›„å°æ¸¯æ©Ÿå ´" },
                { time: "15:00", title: "é£¯åº— Check-in", type: "hotel", desc: "è¡Œææ”¾ç½®ã€‚", loc: "æ„›æ²³æ—¥å¤®" },
                { time: "19:30", title: "é…’è‚‰æ­¦æ—", type: "food", desc: "æ™šé¤æ™‚å…‰ã€‚", loc: "é…’è‚‰æ­¦æ—", tags: ["BOOKING"] }
            ]
        },
        {
            date: "02/20 (äº”)",
            events: [
                { time: "08:30", title: "å¤§ã„ã„¡èƒ–ç¢³çƒ¤ä¸‰æ˜æ²»", type: "food", desc: "æ—©é¤ã€‚", loc: "å¤§ã„ã„¡èƒ–ç¢³çƒ¤ä¸‰æ˜æ²»" },
                { time: "10:00", title: "é§äºŒè—è¡“ç‰¹å€", type: "spot", desc: "åˆ (Cho) 12:00 æŠµé”å¾Œæœƒåˆã€‚", loc: "é§äºŒè—è¡“ç‰¹å€" },
                { time: "12:00", title: "CODA coffee", type: "food", desc: "ğŸš¶ æ­¥è¡Œç´„ 6 åˆ†é˜ã€‚", loc: "CODA coffee", tags: ["WALK 6M"] },
                { time: "13:15", title: "ç§»å‹•ï¼šå…¬äº¤ 56A", type: "transport", desc: "ğŸšŒ å‰å¾€å‹•ç‰©åœ’ã€‚", loc: "56Aå…¬è»Šç«™", tags: ["BUS 56A"] },
                { time: "13:30", title: "å£½å±±å‹•ç‰©åœ’", type: "spot", desc: "çœ‹æ°´è±šã€‚", loc: "å£½å±±å‹•ç‰©åœ’" },
                { time: "16:45", title: "ç§»å‹•ï¼šå…¬äº¤ 56A", type: "transport", desc: "ğŸšŒ å‰å¾€åºœåŒ—è·¯ç«™ã€‚", loc: "åºœåŒ—è·¯å…¬è»Šç«™", tags: ["BUS 56A"] },
                { time: "17:15", title: "æ–°å €æ±Ÿ / å¤¾å­åœ’", type: "spot", desc: "å¤¾å¨ƒå¨ƒã€é’èœæ¨‚åœ’ã€‚", loc: "æ–°å €æ±Ÿå•†åœˆ" },
                { time: "19:40", title: "éŠ…èŠ±ç²¾ç·»æ¶®æ¶®é‹", type: "food", desc: "é«˜ç´šæ™šé¤ã€‚", loc: "éŠ…èŠ±ç²¾ç·»æ¶®æ¶®é‹", tags: ["BOOKING"] }
            ]
        },
        {
            date: "02/21 (å…­)",
            events: [
                { time: "09:00", title: "èˆˆéš†å±…", type: "food", desc: "æ—©é¤ã€‚", loc: "èˆˆéš†å±…" },
                { time: "10:30", title: "Mystoto å¯†å®¤é€ƒè„«", type: "spot", desc: "è§£è¬æŒ‘æˆ°ã€‚", loc: "Mystotoå¯†å®¤é€ƒè„«", tags: ["BOOKING"] },
                { time: "12:10", title: "ç‚¸è¨˜ (åˆé¤)", type: "food", desc: "ğŸš¶ æ­¥è¡Œç´„ 10 åˆ†é˜ã€‚", loc: "ç‚¸è¨˜", tags: ["WALK 10M"] },
                { time: "13:30", title: "SKM Park / è³½é“", type: "spot", desc: "å¡ä¸è»Šã€‚", loc: "SKM Park" },
                { time: "18:45", title: "ç§»å‹•ï¼šæ·é‹ç´…ç·š", type: "transport", desc: "ğŸš‡ å‰å¾€ä¸‰å¤šå•†åœˆã€‚", loc: "ä¸‰å¤šå•†åœˆç«™", tags: ["METRO"] },
                { time: "19:15", title: "è‹“é›…å¸‚å ´ / è‡ªå¼·å¤œå¸‚", type: "food", desc: "åœ¨åœ°ç¾é£Ÿã€‚", loc: "è‡ªå¼·å¤œå¸‚" },
                { time: "21:00", title: "ä¸æƒ³æ´—é ­â€¢è¶Šå¼æ´—é«®", type: "spot", desc: "æŒ‰æ‘©æ”¾é¬†ã€‚", loc: "ä¸æƒ³æ´—é ­è¶Šå¼æ´—é«®", tags: ["BOOKING"] }
            ]
        },
        {
            date: "02/22 (æ—¥)",
            events: [
                { time: "07:00", title: "æ™¨é–“æ¢³æ´—", type: "hotel", desc: "æº–å‚™å‡ºç™¼ã€‚", loc: "æ„›æ²³æ—¥å¤®" },
                { time: "08:00", title: "å¤§ç”°æ—©é¤åº—", type: "food", desc: "ğŸš¶ æ­¥è¡Œç´„ 3 åˆ†é˜ã€‚", loc: "å¤§ç”°æ—©é¤åº—", tags: ["WALK 3M"] },
                { time: "10:30", title: "ç¾æ¿ƒä¸€æ—¥éŠ", type: "spot", desc: "ğŸš— Uber è»Šç¨‹ç´„ 80åˆ†ã€‚", loc: "ç¾æ¿ƒæ°‘ä¿—æ‘", tags: ["UBER 80M"] },
                { time: "17:40", title: "é˜¿é¦™çš„å»šæˆ¿", type: "food", desc: "è¾¦æ¡Œæ–™ç† (Booked)ã€‚", loc: "é˜¿é¦™çš„å»šæˆ¿", tags: ["BOOKING"] },
                { time: "20:30", title: "è¿”å›ä¼‘æ¯", type: "hotel", desc: "ä¼‘æ¯å……é›»ã€‚", loc: "æ„›æ²³æ—¥å¤®" }
            ]
        },
        {
            date: "02/23 (ä¸€)",
            events: [
                { time: "07:30", title: "Check-out", type: "hotel", desc: "æ¢³æ´— & é€€æˆ¿ã€‚", loc: "æ„›æ²³æ—¥å¤®" },
                { time: "09:00", title: "æ™¨é–“å»šæˆ¿", type: "food", desc: "ğŸ‘‹ èˆ‡ Boyi é“åˆ¥ã€‚", loc: "æ™¨é–“å»šæˆ¿å‰é‡‘æˆåŠŸåº—" },
                { time: "10:00", title: "ä¿®è£œéºæ†¾æ™‚é–“", type: "spot", desc: "æœ€å¾Œè³¼ç‰©ã€‚", loc: "é«˜é›„å¸‚" },
                { time: "12:00", title: "Boyi å‰å¾€æ©Ÿå ´", type: "transport", desc: "âœˆï¸ Boyi 12:45 èµ·é£›ã€‚", loc: "å°æ¸¯æ©Ÿå ´", tags: ["VJ885"] },
                { time: "16:00", title: "æŠµé”æ©Ÿå ´ (HKçµ„)", type: "transport", desc: "è¾¦ç†ç™»æ©Ÿã€‚", loc: "å°æ¸¯æ©Ÿå ´" },
                { time: "18:00", title: "è¿”ç¨‹ CI935", type: "transport", desc: "âœˆï¸ KHH -> HKGã€‚", loc: "å°æ¸¯æ©Ÿå ´", tags: ["HOME"] }
            ]
        }
    ];

    // === 2. Core Init & Itinerary Logic ===
    function init() { 
        renderDateTabs(); 
        renderCards(0); 
        initMoneySection();
        updateBalance();
    }

    function renderDateTabs() {
        const container = document.getElementById('date-tabs');
        itinerary.forEach((day, index) => {
            const chip = document.createElement('div');
            chip.className = `date-chip ${index === 0 ? 'active' : ''}`;
            chip.innerText = day.date.split(' ')[0];
            chip.onclick = () => {
                document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                renderCards(index);
            };
            container.appendChild(chip);
        });
    }

    function renderCards(dayIndex) {
        const container = document.getElementById('cards-container');
        document.getElementById('header-subtitle').innerText = `Day ${dayIndex + 1} â€¢ ${itinerary[dayIndex].date}`;
        container.innerHTML = '';
        itinerary[dayIndex].events.forEach(event => {
            const card = document.createElement('div');
            card.className = `card type-${event.type}`;
            let tagsHtml = event.tags ? event.tags.map(tag => {
                let cls = 'tag-booking';
                if(tag.includes('WALK')) cls = 'tag-walk';
                if(tag.includes('BUS') || tag.includes('UBER') || tag.includes('METRO')) cls = 'tag-bus';
                return `<span class="tag ${cls}">${tag}</span>`;
            }).join('') : '';
            
            const mapLink = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(event.loc);
            card.innerHTML = `
                <span class="card-time">${event.time}</span>
                <div class="card-title">${event.title}</div>
                <div class="card-desc">${event.desc}</div>
                ${tagsHtml ? `<div style="margin-bottom:10px;">${tagsHtml}</div>` : ''}
                <a href="${mapLink}" target="_blank" class="btn-nav">ğŸ“ å°èˆª</a>
            `;
            container.appendChild(card);
        });
    }

    function switchTab(sectionId, navElement) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        navElement.classList.add('active');
    }

    // === 3. Money / Expense Logic ===
    let expenses = JSON.parse(localStorage.getItem('khh_expenses')) || [];

    // Make function global for onclick
    window.deleteExpense = function(id) {
        if(confirm("ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ")) {
            expenses = expenses.filter(e => e.id !== id);
            saveAndRender();
        }
    }

    function initMoneySection() {
        // Populate Payer Select
        const payerSelect = document.getElementById('m-payer');
        const targetDiv = document.getElementById('m-targets');
        
        // Prevent duplicate appending if re-init
        payerSelect.innerHTML = '';
        targetDiv.innerHTML = '';
        
        members.forEach((m, idx) => {
            // Payer Options
            let opt = document.createElement('option');
            opt.value = m;
            opt.innerText = m;
            payerSelect.appendChild(opt);

            // Target Checks
            let chip = document.createElement('div');
            chip.className = 'member-check-item checked';
            chip.innerText = m;
            chip.dataset.name = m;
            chip.onclick = function() { this.classList.toggle('checked'); };
            targetDiv.appendChild(chip);
        });
    }

    window.toggleAllChecks = function() {
        const all = document.querySelectorAll('.member-check-item');
        const anyUnchecked = Array.from(all).some(el => !el.classList.contains('checked'));
        all.forEach(el => {
            if(anyUnchecked) el.classList.add('checked');
            else el.classList.remove('checked');
        });
    }

    window.addExpense = function() {
        const desc = document.getElementById('m-desc').value;
        const amt = parseFloat(document.getElementById('m-amt').value);
        const payer = document.getElementById('m-payer').value;
        
        const checkedEls = document.querySelectorAll('.member-check-item.checked');
        const targets = Array.from(checkedEls).map(el => el.dataset.name);

        if(!desc || isNaN(amt) || targets.length === 0) {
            alert("è«‹è¼¸å…¥é …ç›®ã€é‡‘é¡ï¼Œä¸¦è‡³å°‘é¸æ“‡ä¸€å€‹åˆ†æ”¤è€…ã€‚");
            return;
        }

        const expense = {
            id: Date.now(),
            desc: desc,
            amt: amt,
            payer: payer,
            targets: targets,
            timestamp: new Date().toLocaleString()
        };

        expenses.push(expense);
        saveAndRender();
        
        // Clear inputs
        document.getElementById('m-desc').value = '';
        document.getElementById('m-amt').value = '';
    }

    window.clearAllData = function() {
        if(confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰è¨˜å¸³è³‡æ–™ä¸”ç„¡æ³•å¾©åŸï¼ç¢ºå®šå—ï¼Ÿ")) {
            expenses = [];
            saveAndRender();
        }
    }

    function saveAndRender() {
        localStorage.setItem('khh_expenses', JSON.stringify(expenses));
        updateBalance();
    }

    function updateBalance() {
        // Init Balances
        let balances = {};
        members.forEach(m => balances[m] = 0);

        const historyDiv = document.getElementById('history-list');
        historyDiv.innerHTML = '';

        // Calculate
        expenses.forEach(exp => {
            // Payer paid full amount (+ for payer)
            balances[exp.payer] += exp.amt;
            
            // Split amount per person
            const splitAmt = exp.amt / exp.targets.length;
            
            // Subtract from targets (- for consumer)
            exp.targets.forEach(t => {
                if(balances[t] !== undefined) {
                    balances[t] -= splitAmt;
                }
            });

            // Render History
            let item = document.createElement('div');
            item.className = 'history-item';
            
            // CHANGED: Use <button> for delete to ensure iOS works
            item.innerHTML = `
                <div>
                    <div class="history-desc">${exp.desc} <span style="color:#888; font-weight:normal;">$${exp.amt}</span></div>
                    <div class="history-detail">${exp.payer} ä»˜æ¬¾ â†’ åˆ†çµ¦ ${exp.targets.length} äºº</div>
                </div>
                <div style="display:flex; align-items:center;">
                    <span style="font-size:11px; color:#ccc; margin-right:5px;">${exp.timestamp.split(' ')[0]}</span>
                    <button class="btn-delete" type="button" onclick="deleteExpense(${exp.id})">âœ–</button>
                </div>
            `;
            historyDiv.prepend(item); // Newest first
        });

        // Render Balance List
        const balDiv = document.getElementById('balance-list');
        balDiv.innerHTML = '';
        
        // Sort by amount
        let sortedMembers = Object.keys(balances).sort((a,b) => balances[b] - balances[a]);

        sortedMembers.forEach(m => {
            const val = balances[m];
            if(Math.abs(val) < 1) return; // Hide 0

            let row = document.createElement('div');
            row.className = 'balance-card';
            
            const isPlus = val > 0;
            const colorClass = isPlus ? 'is-plus' : 'is-minus';
            const statusText = isPlus ? 'æ‡‰æ”¶ (Get)' : 'æ‡‰ä»˜ (Pay)';
            
            row.innerHTML = `
                <div>
                    <div style="font-weight:bold; font-size:15px;">${m}</div>
                    <div style="font-size:12px; color:#888;">${statusText}</div>
                </div>
                <div class="balance-amt ${colorClass}">
                    ${isPlus ? '+' : ''}${Math.round(val)}
                </div>
            `;
            balDiv.appendChild(row);
        });
        
        if(expenses.length === 0) {
            historyDiv.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">å°šç„¡ç´€éŒ„</div>';
        }
    }

    init();

</script>
</body>
</html>
